// JavaScript Code for the Mafia Game Logic

let players = []; // قائمة اللاعبين
let roles = ["مافيا", "الطبيب", "المحقق", "مدني"]; // الأدوار المتاحة
let assignedRoles = {}; // تخزين الأدوار لكل لاعب
let currentPlayerIndex = 0; // تتبع اللاعب الحالي
let investigatorPlayer = null; // تحديد المحقق

const roleName = document.getElementById("role-name");
const roleImage = document.getElementById("role-image");
const nextTurnButton = document.getElementById("next-turn");
const askPlayerSelect = document.getElementById("ask-player-select");
const askButton = document.getElementById("ask-button");
const askResult = document.getElementById("ask-result");

function startGame() {
    currentPlayerIndex = 0;
    assignedRoles = assignRolesToPlayers();
    investigatorPlayer = getInvestigator();
    document.getElementById("player-setup").style.display = "none";
    document.getElementById("game-play").style.display = "block";
    startTurn();
}

function assignRolesToPlayers() {
    let assigned = {};
    let rolesToAssign = [...roles];

    players.forEach(player => {
        if (rolesToAssign.length === 0) {
            assigned[player] = "مدني";
        } else {
            let randomIndex = Math.floor(Math.random() * rolesToAssign.length);
            assigned[player] = rolesToAssign[randomIndex];
            rolesToAssign.splice(randomIndex, 1);
        }
    });
    return assigned;
}

function getInvestigator() {
    return Object.keys(assignedRoles).find(player => assignedRoles[player] === "المحقق");
}

function startTurn() {
    if (currentPlayerIndex >= players.length) {
        alert("انتهت اللعبة!");
        return;
    }

    const playerName = players[currentPlayerIndex];
    const role = assignedRoles[playerName];

    alert(`${playerName}, مرر الجهاز لكشف دورك. اضغط موافق لعرض الدور.`);

    roleName.textContent = `دور ${playerName}`;
    roleImage.src = getRoleImage(role);
    roleImage.style.display = "block";
    nextTurnButton.style.display = "block";

    currentPlayerIndex++;
}

nextTurnButton.addEventListener("click", () => {
    roleImage.style.display = "none";
    roleName.textContent = "";
    nextTurnButton.style.display = "none";

    if (players[currentPlayerIndex - 1] === investigatorPlayer) {
        enableInvestigatorMode();
    } else {
        startTurn();
    }
});

function enableInvestigatorMode() {
    askPlayerSelect.innerHTML = "";

    players.forEach((player, index) => {
        if (player !== investigatorPlayer) {
            let option = document.createElement("option");
            option.value = index;
            option.textContent = player;
            askPlayerSelect.appendChild(option);
        }
    });

    document.getElementById("investigator-mode").style.display = "block";
}

askButton.addEventListener("click", () => {
    const selectedPlayerIndex = askPlayerSelect.value;
    const selectedPlayerName = players[selectedPlayerIndex];
    const role = assignedRoles[selectedPlayerName];

    if (role === "مافيا") {
        askResult.textContent = `${selectedPlayerName} هو مافيا.`;
    } else {
        askResult.textContent = `${selectedPlayerName} هو مواطن.`;
    }

    setTimeout(() => {
        document.getElementById("investigator-mode").style.display = "none";
        askResult.textContent = "";
        startTurn();
    }, 3000); // عرض النتيجة لمدة 3 ثوانٍ قبل الانتقال
});

function getRoleImage(role) {
    if (role === "مافيا") return "images/Mafia.png";
    if (role === "الطبيب") return "images/doctor.png";
    if (role === "المحقق") return "images/Investigator.png";
    return "images/civilian.png";
}
